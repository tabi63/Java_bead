<!DOCTYPE html>
<html>
<head><title>Edit Order</title></head>
<body>
<h1>Edit Order</h1>
<form th:action="@{/orders/save}" method="post" th:object="${order}">
  <input type="hidden" th:field="*{id}"/>

  <label>Customer Name:</label>
  <input type="text" th:field="*{customerName}" required/><br/>
  <label>Customer Address:</label>
  <input type="text" th:field="*{customerAddress}" required/><br/>
  <label>Order Date:</label>
  <input type="date" th:field="*{orderDate}" required/><br/>
  <label>Amount:</label>
  <input type="number" th:field="*{amount}" disabled/><br/>

  <div th:if="${order.id != null}">
    <label>Status:</label>
    <select name="orderState.id" id="orderState">
      <option th:each="state : ${orderStates}" 
              th:value="${state.id}" 
              th:text="${state.description}" 
              th:selected="${state.id == order.orderState?.id}">
      </option>
    </select>
    <br/>
  </div>

  <h2>Order Items</h2>

  <div id="orderItems">
    <div th:each="item, iterStat : *{orderItems}" data-index="__${iterStat.index}__">
      <input type="hidden" th:field="*{orderItems[__${iterStat.index}__].id}"/>
      
      <label>Product Name:</label>
      <input type="text" th:field="*{orderItems[__${iterStat.index}__].productName}" required/>

      <label>Piece:</label>
      <input type="number" th:field="*{orderItems[__${iterStat.index}__].piece}" required onchange="updateGrandTotal()"/>

      <label>Unit Price:</label>
      <input type="number" th:field="*{orderItems[__${iterStat.index}__].unitPrice}" required onchange="updateGrandTotal()"/>

      <button type="button" onclick="removeItem(this)">Remove</button>
      <br/><br/>
    </div>
  </div>

  <button type="button" onclick="addItem()">Add Item</button>
  <br/><br/>

  <button type="submit">Save</button>
</form>

<script>
  function addItem() {
      const container = document.getElementById('orderItems');
      const index = container.children.length;
      const newItem = document.createElement('div');
  
      newItem.innerHTML = `
        <div data-index="${index}">
          <input type="hidden" name="orderItems[${index}].id" />
          <label>Product Name:</label>
          <input type="text" name="orderItems[${index}].productName" required/>
  
          <label>Piece:</label>
          <input type="number" name="orderItems[${index}].piece" required onchange="updateGrandTotal()" />
  
          <label>Unit Price:</label>
          <input type="number" name="orderItems[${index}].unitPrice" required onchange="updateGrandTotal()" />
  
          <button type="button" onclick="removeItem(this)">Remove</button>
          <br/><br/>
        </div>
      `;
  
      container.appendChild(newItem);
  }

  function updateGrandTotal() {
      let amount = 0;

      document.querySelectorAll('div[data-index]').forEach(function(itemDiv) {
        const index = itemDiv.dataset.index;

        const pieceInput = itemDiv.querySelector('input[name$=".piece"]');
        const unitPriceInput = itemDiv.querySelector('input[name$=".unitPrice"]');

        const piece = parseFloat(pieceInput.value);
        const unitPrice = parseFloat(unitPriceInput.value);

        if (!isNaN(piece) && !isNaN(unitPrice)) {
          amount += piece * unitPrice;
        }
      });

      document.getElementById('amount').value = amount;
  }
  
  function removeItem(button) {
      button.parentElement.remove();
      updateGrandTotal();
  }
</script>
</body>
</html>
